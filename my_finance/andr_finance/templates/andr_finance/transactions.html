{% extends "andr_finance/base.html" %}
{% load static %}
{% load andr_finance_extras %}

{% block content %}

    <h2>Транзакции:</h2>

    <form action="{% url 'andr_finance:transactions' %}" method='get' id="form_filter">
        <input name="sort_field" value="{{ sort_field }}" type="hidden">
        <input name="sort_order" value="{{ sort_order }}" type="hidden">
        <div class="row g-2">
            <div class="col-md">
                <div class="form-floating">
                    <select name="filter_account" id="filter_account" class="form-select">
                        <option
                                value="0"
                                {% if filter_account == '0' %}
                                selected
                                {% endif %} >
                            --- Не выбрано ---
                        </option>
                        {% for account in accounts %}
                            <option
                                    value="{{ account.id }}"
                                    {% if filter_account == account.id|stringformat:"s" %}
                                    selected
                                    {% endif %}
                            >{{ account.name }}</option>
                        {% endfor %}
                    </select>
                    <label for="filter_account">Счет:</label>
                </div>
            </div>
            <div class="col-md">
                <div class="form-floating">
                    <select name="filter_category" id="filter_category" class="form-select">
                        <option
                                value="0"
                                {% if filter_category == '0' %}
                                selected
                                {% endif %} >
                            --- Не выбрано ---
                        </option>
                        {% for category in categories %}
                            <option
                                    value="{{ category.id }}"
                                    {% if filter_category == category.id|stringformat:"s" %}
                                    selected
                                    {% endif %}
                            >{{ category.name }}</option>
                        {% endfor %}
                    </select>
                    <label for="filter_category">Категория:</label>
                </div>
            </div>
            <div class="col-md">
                <div class="form-floating">
                    <select name="filter_type_transaction" id="filter_type_transaction" class="form-select">
                        <option
                                value="0"
                                {% if filter_category == '0' %}
                                selected
                                {% endif %} >
                            --- Не выбрано ---
                        </option>
                        {% for type_transaction in type_transactions %}
                            <option
                                    value="{{ type_transaction.code }}"
                                    {% if filter_type_transaction == type_transaction.code %}
                                    selected
                                    {% endif %}
                            >{{ type_transaction.name }}</option>
                        {% endfor %}
                    </select>
                    <label for="filter_type_transaction">Тип транзакции:</label>
                </div>
            </div>
            <div class="col-md">
                <div class="form-floating">
                    <select name="filter_group" id="filter_group" class="form-select">
                        <option
                                value="0"
                                {% if filter_group == 'not_group' %}selected{% endif %}
                        >--- Не группировать ---
                        </option>
                        <option
                                value="category"
                                {% if filter_group == 'category' %}selected{% endif %}
                        >Категориям
                        </option>
                        <option
                                value="date"
                                {% if filter_group == 'date' %}selected{% endif %}
                        >Датам
                        </option>
                    </select>
                    <label for="filter_group">Группировать по:</label>
                </div>
            </div>
        </div>

        <div class="row g-2 mt-1">
            <div class="col-md-3">
                <div class="" id="sandbox-container">
                    <label>Период:</label>
                    <div class="input-daterange input-group" id="datepicker">
                        <input type="text" class="input-sm form-control" name="filter_date_start"
                               value="{{ filter_date_start }}" autocomplete="off"/>
                        <span class="input-group-addon">до</span>
                        <input type="text" class="input-sm form-control" name="filter_date_end"
                               value="{{ filter_date_end }}" autocomplete="off"/>
                    </div>
                </div>
            </div>
        </div>

        <button class="btn btn-outline-primary btn-sm mt-2" type="submit">Сформировать</button>
    </form>

    <form action="{% url 'andr_finance:transaction_add' 'minus' %}">
        <button type="submit" class="btn btn-outline-primary btn-sm mt-2">Добавить транзакцию</button>
    </form>

    <div class="table-responsive">
        <table class="table table-hover table-sm mt-3 table_transaction">
            <thead class="table-light">
            <tr class="tr_sort">
                <th scope="col"></th>
                <th scope="col">
                    <span
                            class="text-secondary-emphasis name_col"
                            data-sort-field="category"
                            data-sort-order="{% if sort_field == 'category' %}{{ sort_order }}{% endif %}"

                    >Категория
                        {% if sort_field == 'category' %}
                            {% if sort_order == 'asc' %}
                            <img src="{% static 'andr_finance/images/sort-down.svg' %}" alt="">
                            {% elif sort_order == 'desc' %}
                                <img src="{% static 'andr_finance/images/sort-up.svg' %}" alt="">
                            {% endif %}
                        {% endif %}
                    </span>
                </th>
                <th scope="col">
                    <span
                            class="text-secondary-emphasis name_col"
                            data-sort-field="amount"
                            data-sort-order="{% if sort_field == 'amount' %}{{ sort_order }}{% endif %}"
                    >Сумма
                        {% if sort_field == 'amount' %}
                            {% if sort_order == 'asc' %}
                            <img src="{% static 'andr_finance/images/sort-down.svg' %}" alt="">
                            {% elif sort_order == 'desc' %}
                                <img src="{% static 'andr_finance/images/sort-up.svg' %}" alt="">
                            {% endif %}
                        {% endif %}
                    </span>
                </th>
                <th scope="col">
                    <span
                            class="text-secondary-emphasis"
                            data-sort-field="balance"
                            data-sort-order=""
                    >Баланс</span>
                </th>
                <th scope="col">
                    <span
                            class="text-secondary-emphasis name_col"
                            data-sort-field="account"
                            data-sort-order="{% if sort_field == 'account' %}{{ sort_order }}{% endif %}"
                    >Счет
                        {% if sort_field == 'account' %}
                            {% if sort_order == 'asc' %}
                            <img src="{% static 'andr_finance/images/sort-down.svg' %}" alt="">
                            {% elif sort_order == 'desc' %}
                                <img src="{% static 'andr_finance/images/sort-up.svg' %}" alt="">
                            {% endif %}
                        {% endif %}
                    </span>
                </th>
                <th scope="col">
                    <span
                            class="text-secondary-emphasis name_col"
                            data-sort-field="date_add"
                            data-sort-order="{% if sort_field == 'date_add' %}{{ sort_order }}{% endif %}"
                    >Дата
                        {% if sort_field == 'date_add' %}
                            {% if sort_order == 'asc' %}
                            <img src="{% static 'andr_finance/images/sort-down.svg' %}" alt="">
                            {% elif sort_order == 'desc' %}
                                <img src="{% static 'andr_finance/images/sort-up.svg' %}" alt="">
                            {% endif %}
                        {% endif %}
                    </span>
                </th>
                <th scope="col">
                    <span
                            class="text-secondary-emphasis name_col"
                            data-sort-field="title"
                            data-sort-order="{% if sort_field == 'title' %}{{ sort_order }}{% endif %}"
                    >Оп.
                        {% if sort_field == 'title' %}
                            {% if sort_order == 'asc' %}
                            <img src="{% static 'andr_finance/images/sort-down.svg' %}" alt="">
                            {% elif sort_order == 'desc' %}
                                <img src="{% static 'andr_finance/images/sort-up.svg' %}" alt="">
                            {% endif %}
                        {% endif %}
                    </span></th>
                <th scope="col"></th>
            </tr>
            </thead>
            <tbody>
            {% if group_by != "" %}
                {% for transaction_group in transactions_group %}
                    <tr
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse_td_{{ transaction_group.category_id }}"
                            aria-expanded="false"
                            aria-controls="collapse_td_{{ transaction_group.category_id }}"
                            class="tr_group"
                    >
                        <td>
                            <span class="group_chevron_right">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                     class="bi bi-chevron-right" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                          d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                                </svg>
                            </span>
                        </td>
                        <td
                                class="fw-bold"
                        >{{ transaction_group.category_name }}</td>
                        <td class="fw-bold text-end">{{ transaction_group.total }}</td>
                        <td colspan="6"></td>
                    </tr>
                    {% for transaction in transaction_group.transactions %}
                        {% tr_transaction transaction balances transaction_group.category_id icon_default %}
                    {% endfor %}
                {% endfor %}
            {% else %}
                {% for transaction in transactions %}
                    {% tr_transaction transaction balances None icon_default %}
                {% empty %}
                    <tr>
                        <td>Нет транзакций</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                {% endfor %}
            {% endif %}
            </tbody>
        </table>
    </div>

    <script>
        $(document).ready(function () {
            
            $('table.table_transaction thead th span.name_col').click(function (event) {
                $('input[name=sort_field]').val($(this).attr('data-sort-field'))

                let sort_order = $(this).attr('data-sort-order')
                if (sort_order === 'asc') {
                    sort_order = 'desc'
                }
                else if (sort_order === 'desc') {
                    sort_order = 'asc'
                }
                else {
                    sort_order = 'asc'
                }
                $('input[name=sort_order]').val(sort_order)

                $('form#form_filter').submit();
            });
            
            
            $('#sandbox-container .input-daterange').datepicker({
                todayBtn: "linked",
                clearBtn: true,
                language: "ru",
                autoclose: true,
                todayHighlight: true
            });
            
        });
        
    </script>


{% endblock content %}